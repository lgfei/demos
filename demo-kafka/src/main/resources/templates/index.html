<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Kafka SSE 时间区间消费</title>
    <style>
        body { font-family: monospace; background: #f0f0f0; padding: 20px; }
        #messages { white-space: pre-wrap; background: #fff; padding: 10px; border: 1px solid #ccc; height: 500px; overflow-y: auto; margin-top: 10px; }
        .msg { margin-bottom: 4px; }
        .controls { margin-bottom: 10px; }
        label { margin-right: 5px; }
    </style>
</head>
<body>
<h2>Kafka SSE 时间区间消费</h2>

<div class="controls">
    <label for="topic">Topic:</label>
    <input type="text" id="topic" value="tidb_retail">

    <label for="startTime">开始时间:</label>
    <input type="datetime-local" id="startTime">

    <label for="endTime">结束时间:</label>
    <input type="datetime-local" id="endTime">

    <button id="startBtn">开始消费</button>
</div>

<div id="messages"></div>

<script>
    function setDefaultDatetime() {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const yyyy = now.getFullYear();
        const MM = pad(now.getMonth() + 1);
        const dd = pad(now.getDate());
        const HH = pad(now.getHours());
        const mm = pad(now.getMinutes());

        const defaultValue = `${yyyy}-${MM}-${dd}T${HH}:${mm}`;
        document.getElementById("startTime").value = defaultValue;
        document.getElementById("endTime").value = defaultValue;
    }

    window.onload = setDefaultDatetime;

    const messagesDiv = document.getElementById("messages");
    const startBtn = document.getElementById("startBtn");
    let es; // SSE 对象

    const pad = n => n.toString().padStart(2, '0');

    // 将 datetime-local 转换为 yyyy-MM-dd HH:mm:ss
    function formatDatetime(dt) {
        const date = new Date(dt);
        return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    startBtn.addEventListener("click", () => {
        const topic = document.getElementById("topic").value;
        const startDt = document.getElementById("startTime").value;
        const endDt = document.getElementById("endTime").value;

        if (!topic || !startDt || !endDt) {
            alert("请填写 Topic、开始时间和结束时间");
            return;
        }

        const startTime = formatDatetime(startDt);
        const endTime = formatDatetime(endDt);

        // 关闭已有 SSE 连接
        if (es) es.close();
        messagesDiv.innerHTML = "";

        // 建立 SSE 连接
        es = new EventSource(`/kafka/consume?topic=${topic}&start=${encodeURIComponent(startTime)}&end=${encodeURIComponent(endTime)}`);

        es.onmessage = e => {
            const div = document.createElement("div");
            div.className = "msg";
            div.textContent = e.data;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        es.addEventListener("complete", e => {
            const div = document.createElement("div");
            div.style.color = "green";
            div.textContent = "✅ 消费完成";
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        es.onerror = e => {
            const div = document.createElement("div");
            div.style.color = "red";
            div.textContent = "❌ SSE 连接出错或断开";
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            es.close();
        };
    });
</script>
</body>
</html>
